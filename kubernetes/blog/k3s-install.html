
<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <title>K3s 安装 | IceOfSummerの博客</title>
        <meta name="author" content="IceOfSummer" />
        <meta name="description" content="后面一辈子的博客都在这了！" />
        <meta name="keywords" content="" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
        <script src="https://selfb.asia/static/lib/vue-3.2.47.global.prod.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.3.0/css/all.min.css" />
<link rel="stylesheet" href="https://selfb.asia/static/particlex/static/fonts.min.css" />
<script>
  const mixins = {};
  const h = (arg1, arg2, arg3) => {
    if (arg2.attrs) {
      Object.assign(arg2, arg2.attrs)
      Reflect.deleteProperty(arg2, 'attrs')
    }
    if (arg2.on) {
      Object.keys(arg2.on).forEach(key => {
        const head = key.charAt(0).toUpperCase()
        arg2['on' + head  + key.substring(1)] = arg2.on[key]
      })
      Reflect.deleteProperty(arg2, 'on')
    }
    return Vue.h(arg1, arg2, arg3)
  }
</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>


<script src="https://selfb.asia/static/lib/highlight-11.7.0.min.js"></script>
<link
    rel="stylesheet"
    href="https://cdn.staticfile.org/highlight.js/11.7.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

  <script src="/js/lib/toc.js"></script>



  <script src="/js/lib/lazy-load-support.js"></script>


    <meta name="generator" content="Hexo 7.3.0"></head>
    <body>
        <div id="layout">
            <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
            </transition>
            <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/">
            <span>ICEOFSUMMERの博客</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;ICEOFSUMMERの博客</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>K3s 安装</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/7/4
        </span>
        
        <span class="category">
            <a href="/2024/02/08/k8s">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                k8s
            </a>
        </span>
        
        
    </div>
    
    <toc-component></toc-component>
    <div class="content" v-pre id="main-content">
        <h1 id="系统需求"><a href="#系统需求" class="headerlink" title="系统需求"></a>系统需求</h1><blockquote>
<p>K3s 是一个轻量级 K8s，当你的节点数较少时，应该优先考虑使用 K3s，直接使用 K8s 有点过于大材小用。</p>
<p>例如你的公司有一套软件可以使用 helm 进行分发，但是一般客户只会提供资源有限的节点，直接安装 K8s 是不太现实的，此时 K3s 就是最好的选择。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.k3s.io/zh/installation/requirements?os=debian">Requirements</a></p>
<p>K3s 至少需要如下资源才能被安装：</p>
<ul>
<li>CPU：最低 1 核，推荐 2 核</li>
<li>RAM：最低 512MB，推荐 1GB</li>
</ul>
<p>相比与另外一个轻量级 K8s：<a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/">minikube</a>，K3s 的优势是<strong>能够用于生产模式</strong>，而 minukube 仅用于学习 K8s，下面引用<a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/faq/">官方原话</a>：</p>
<pre><code class="text">minikube’s primary goal is to quickly set up local Kubernetes clusters, and therefore we strongly discourage using minikube in production or for listening to remote traffic. By design, minikube is meant to only listen on the local network.
</code></pre>
<p>同时还有个 issue：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/minikube/issues/10097">Running minikube in production is [not] stupid?</a></p>
<h1 id="准备配置文件"><a href="#准备配置文件" class="headerlink" title="准备配置文件"></a>准备配置文件</h1><p>为了避免后面又重启啥的，所以建议一次性把配置文件准备好，创建文件 <code>/etc/rancher/k3s/config.yaml</code>.</p>
<h2 id="内嵌镜像仓库"><a href="#内嵌镜像仓库" class="headerlink" title="内嵌镜像仓库"></a>内嵌镜像仓库</h2><p><a target="_blank" rel="noopener" href="https://docs.k3s.io/zh/installation/registry-mirror">Embedded Registry Mirror</a></p>
<p>K3s 提供了内建镜像仓库，可以直接在节点间共享镜像，<strong>默认是关闭的</strong>，如果不需要开启，则可以直接跳过这节。</p>
<p>开启内嵌镜像仓库：</p>
<pre><code class="yaml">embedded-registry: true 
</code></pre>
<p>内嵌镜像仓库不能直接通过 push 上传镜像，必须使用 <code>ctr -n k8s.io import</code> 或者 <code>ctr -n k8s.io load</code> 来导入。</p>
<h2 id="配置镜像源"><a href="#配置镜像源" class="headerlink" title="配置镜像源"></a>配置镜像源</h2><p><a target="_blank" rel="noopener" href="https://docs.k3s.io/zh/installation/private-registry">Private Registry Configuration</a></p>
<p>在<strong>每个节点</strong>创建文件：<code>/etc/rancher/k3s/registries.yaml</code>，这个文件仅对单个节点有效。</p>
<p>添加镜像源：</p>
<pre><code class="yaml">mirrors:
  docker.io:
    endpoint:
      - &quot;https://registry.example.com:5000&quot;
</code></pre>
<p>如果需要配置认证，请自行查阅官方文档。</p>
<h2 id="准备安装"><a href="#准备安装" class="headerlink" title="准备安装"></a>准备安装</h2><p>首先非常蛋疼的是和 K8s 一样，你要是完全跟着官方步骤走，是肯定搞不了的，资源要么在 GitHub 上，要么就是被墙了。</p>
<p>但是有大佬已经为我们准备了镜像源：<a target="_blank" rel="noopener" href="https://forums.rancher.cn/t/k3s/1416">使用国内资源安装K3s</a>。</p>
<p>你可以直接照着上面的步骤走，也可以看我自己是怎么搞的。</p>
<hr>
<p>下载脚本：</p>
<pre><code class="sh">curl -O https://rancher-mirror.rancher.cn/k3s/k3s-install.sh &gt; k3s-install.sh
</code></pre>
<p>添加镜像文件：</p>
<pre><code class="sh">cat &gt; /etc/rancher/k3s/registries.yaml &lt;&lt;EOF
mirrors:
  docker.io:
    endpoint:
      - &quot;https://registry.cn-hangzhou.aliyuncs.com/&quot;
      - &quot;https://mirror.ccs.tencentyun.com&quot;
  quay.io:
    endpoint:
      - &quot;https://quay.tencentcloudcr.com/&quot;
  registry.k8s.io:
    endpoint:
      - &quot;https://registry.aliyuncs.com/v2/google_containers&quot;
  gcr.io:
    endpoint:
      - &quot;https://gcr.m.daocloud.io/&quot;
  k8s.gcr.io:
    endpoint:
      - &quot;https://registry.aliyuncs.com/google_containers&quot;
  ghcr.io:
    endpoint:
      - &quot;https://ghcr.m.daocloud.io/&quot;
EOF
</code></pre>
<p>指定安装版本(具体有哪些版本可以从 <a target="_blank" rel="noopener" href="https://github.com/k3s-io/k3s/releases">Releases</a> 列表看)：</p>
<pre><code class="sh">INSTALL_K3S_MIRROR=cn INSTALL_K3S_VERSION=v1.28.11+k3s2 sh k3s-install.sh --system-default-registry=&quot;registry.cn-hangzhou.aliyuncs.com&quot;
</code></pre>
<p>如果碰到安装 <code>docker-ce</code> 失败，执行下面的命令添加镜像：</p>
<pre><code class="sh">yum install yum-utils
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</code></pre>
<p>如果 kubectl 没有正确配置，使用下面的配置重新设置配置文件：</p>
<pre><code class="sh">echo &quot;export KUBECONFIG=/etc/rancher/k3s/k3s.yaml&quot; &gt;&gt; /etc/profile
source /etc/profile
</code></pre>

    </div>
    
    
    
    
    <div id="comment">
        <div id="giscus-container" class="giscus"></div>
    </div>
    
    
    
    
</div>

                <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2024 IceOfSummerの博客
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;<a target="_blank" rel="noopener" href="https://github.com/IceOfSummer">IceOfSummer</a>
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/IceOfSummer/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

            </div>
            </transition>
            
            <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
            </transition>
            
        </div>
        <script src="/js/main.js"></script>
        
        
<script
    src="https://giscus.app/client.js"
    data-repo="IceOfSummer/iceofsummer.github.io"
    data-repo-id="R_kgDOJFU7OQ"
    data-category="Announcements"
    data-category-id="DIC_kwDOJFU7Oc4CUyC7"
    data-mapping="title"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="preferred_color_scheme"
    data-lang="zh-CN"
    crossorigin
    async
></script>





        
    </body>
</html>
