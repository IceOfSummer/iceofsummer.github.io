
<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <title>Jenkins | IceOfSummerの博客</title>
        <meta name="author" content="IceOfSummer" />
        <meta name="description" content="后面一辈子的博客都在这了！" />
        <meta name="keywords" content="" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
        <script src="https://cdn.staticfile.org/vue/3.2.47/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.3.0/css/all.min.css" />
<link rel="stylesheet" href="https://selfb.asia/static/particlex/static/fonts.min.css" />
<script>
  const mixins = {};
  const h = (arg1, arg2, arg3) => {
    if (arg2.attrs) {
      Object.assign(arg2, arg2.attrs)
      Reflect.deleteProperty(arg2, 'attrs')
    }
    if (arg2.on) {
      Object.keys(arg2.on).forEach(key => {
        const head = key.charAt(0).toUpperCase()
        arg2['on' + head  + key.substring(1)] = arg2.on[key]
      })
      Reflect.deleteProperty(arg2, 'on')
    }
    return Vue.h(arg1, arg2, arg3)
  }
</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>


<script src="https://cdn.staticfile.org/highlight.js/11.7.0/highlight.min.js"></script>
<link
    rel="stylesheet"
    href="https://cdn.staticfile.org/highlight.js/11.7.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

  <script src="/js/lib/toc.js"></script>



  <script src="/js/lib/lazy-load-support.js"></script>


    <meta name="generator" content="Hexo 7.2.0"></head>
    <body>
        <div id="layout">
            <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
            </transition>
            <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/">
            <span>ICEOFSUMMERの博客</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;ICEOFSUMMERの博客</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>Jenkins</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/6/24
        </span>
        
        <span class="category">
            <a href="/2024/02/08/k8s">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                k8s
            </a>
        </span>
        
        
    </div>
    
    <toc-component></toc-component>
    <div class="content" v-pre id="main-content">
        <h1 id="碰到的坑"><a href="#碰到的坑" class="headerlink" title="碰到的坑"></a>碰到的坑</h1><h2 id="慎用-Docker-安装"><a href="#慎用-Docker-安装" class="headerlink" title="慎用 Docker 安装"></a>慎用 Docker 安装</h2><p>使用 docker 安装最大的一个坑：如果容器删掉了，即使挂载了 jenkins_home 的数据，再重新创建容器，jenkins 版本会直接回退到镜像对应的版本，即使之前升级过了。</p>
<p>这里是因为 jenkins 的 war 包没有被挂载，而 jenkins 的入门教程中，并没有提到怎么挂载 war 包。</p>
<p>这个问题会直接导致，如果你的镜像中 jenkins 版本较低，而插件要求的 jenkins 版本较高，就会导致无法进入控制台。</p>
<p>所以如果要升级jenkins，优先使用升级 docker 镜像的方式升级 jenkins，或者挂载 war 包目录后再升级。</p>
<p>但是这种方法太麻烦了，而且对于 blueocean 这种好几年没更新的镜像，根本没办法升级。</p>
<p>所以推荐直接部署在机器上，而不是使用 docker 启动。</p>
<p>这里是我的启动脚本：</p>
<pre><code class="sh">#/bin/bash

export JENKINS_HOME=/home/jenkins/data
JAVA_HOME=/home/jenkins/openlogic-openjdk-jre-17.0.11+9-linux-x64
JENKINS_OPTS=&quot;--httpPort=8888 --javaHome=$JAVA_HOME&quot;

nohup $JAVA_HOME/bin/java -jar jenkins-2.452.2.war $JENKINS_OPTS &amp;
</code></pre>
<p>可以随意替换 war 包进行升级，并且相比之下也更灵活。</p>
<h3 id="系统恢复"><a href="#系统恢复" class="headerlink" title="系统恢复"></a>系统恢复</h3><p>如果真的碰到了重新创建镜像导致控制台无法打开，可以使用下面的方式修复：</p>
<ol>
<li>删除(备份) jenkins-home 下的 <code>config.xml</code></li>
<li>重启 jenkins</li>
<li>此时 jenkins 虽然安装了之前的插件，但全部处于禁用状态</li>
<li>升级 jenkins，重启</li>
<li>将之前的 <code>config.xml</code> 恢复，重启</li>
</ol>
<h1 id="K8s-集成"><a href="#K8s-集成" class="headerlink" title="K8s 集成"></a>K8s 集成</h1><h2 id="创建服务账号与-K8s-集成"><a href="#创建服务账号与-K8s-集成" class="headerlink" title="创建服务账号与 K8s 集成"></a>创建服务账号与 K8s 集成</h2><p>创建服务账号：</p>
<pre><code class="yaml">apiVersion: v1
kind: ServiceAccount
metadata:
  name: dev-ops-account
  namespace: &#123;&#123; .Release.Namespace &#125;&#125;
  annotations:
    role: ci-cd
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: &#123;&#123; .Release.Namespace &#125;&#125;
  name: dev-ops-role
rules:
  - apiGroups:
      - &quot;apps&quot;
    resources:
      - &quot;deployment&quot;
    verbs:
      - &quot;get&quot;
      - &quot;list&quot;
      - &quot;update&quot;
      - &quot;patch&quot;
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: dev-ops-role-bind
  namespace: &#123;&#123; .Release.Namespace &#125;&#125;
subjects:
  - kind: ServiceAccount
    name: dev-ops-account
roleRef:
  kind: Role
  name: dev-ops-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: Secret
metadata:
  name: dev-ops-token
  namespace: &#123;&#123; .Release.Namespace &#125;&#125;
  annotations:
    kubernetes.io/service-account.name: dev-ops-account
type: kubernetes.io/service-account-token
</code></pre>
<p>获取 token:</p>
<pre><code class="sh">kubectl get secret dev-ops-token -n &#123;&#123; .Release.Namespace &#125;&#125; -o jsonpath=&#39;&#123;.data.token&#125;&#39; | base64 --decode
</code></pre>
<p>调用 Api：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/kubernetes-api/workload-resources/deployment-v1/">Deployment API</a></p>
<p>认证方式是<code>Bearer Token</code>, 需要添加一个 <code>Authorization</code> 请求头，格式为: <code>Bearer &lt;token&gt;</code>.</p>
<p>推荐使用 <code>PATCH</code> 来更新资源，可用的格式可以在这里看 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/using-api/api-concepts/#patch-and-apply">更新现有资源</a></p>
<h1 id="常用插件"><a href="#常用插件" class="headerlink" title="常用插件"></a>常用插件</h1><h2 id="响应式单选-多选插件"><a href="#响应式单选-多选插件" class="headerlink" title="响应式单选&#x2F;多选插件"></a>响应式单选&#x2F;多选插件</h2><p><a target="_blank" rel="noopener" href="https://plugins.jenkins.io/uno-choice/">Active Choices</a></p>
<p>这个插件可以提供单选&#x2F;多选的输入表单，并且它还可以提供根据之前的选项，限制下一个表单展示的内容。</p>
<p>例如第一个单选框是 <code>水果/牛奶</code>：</p>
<ul>
<li>当选择<strong>水果</strong>时，第二个表单提供：苹果、香蕉、葡萄。</li>
<li>当选择<strong>牛奶</strong>时，第二个表单提供：纯牛奶、酸奶。</li>
</ul>
<p>上面的需求用代码实现就是：</p>
<pre><code class="groovy">parameters &#123;
  activeChoice choiceType: &#39;PT_SINGLE_SELECT&#39;,
   filterLength: 1, 
   filterable: false, 
   name: &#39;FoodType&#39;, 
   randomName: &#39;choice-parameter-2439957027861799&#39;, 
   script: groovyScript(
    fallbackScript: [classpath: [], oldScript: &#39;&#39;, sandbox: false, script: &#39;&#39;], 
    script: [
        classpath: [], 
        oldScript: &#39;&#39;, 
        sandbox: false, 
        script: &#39;return [\&#39;水果\&#39;, \&#39;牛奶\&#39;]&#39;]
    )
  reactiveChoice choiceType: &#39;PT_SINGLE_SELECT&#39;,
   filterLength: 1, 
   filterable: false, 
   name: &#39;FoodName&#39;, 
   randomName: &#39;choice-parameter-2439957031262488&#39;, 
   referencedParameters: &#39;FoodType &#39;, 
   script: groovyScript(
    fallbackScript: [classpath: [], oldScript: &#39;&#39;, sandbox: false, script: &#39;&#39;], 
    script: [
        classpath: [], 
        oldScript: &#39;&#39;, 
        sandbox: false, 
        script: &#39;&#39;&#39;
        if (FoodType == \&#39;水果\&#39;) &#123;
            return [\&#39;苹果\&#39;, \&#39;香蕉\&#39;, \&#39;葡萄\&#39;]
        &#125; else if (foodType == \&#39;牛奶\&#39;) &#123;
            return [\&#39;纯牛奶\&#39;, \&#39;酸奶\&#39;]
        &#125;
        return []
    &#39;&#39;&#39;]
    )
  &#125;
</code></pre>

    </div>
    
    
    
    
    <div id="comment">
        <div id="giscus-container" class="giscus"></div>
    </div>
    
    
    
    
</div>

                <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2024 IceOfSummerの博客
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;<a target="_blank" rel="noopener" href="https://github.com/IceOfSummer">IceOfSummer</a>
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/IceOfSummer/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

            </div>
            </transition>
            
            <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
            </transition>
            
        </div>
        <script src="/js/main.js"></script>
        
        
<script
    src="https://giscus.app/client.js"
    data-repo="IceOfSummer/iceofsummer.github.io"
    data-repo-id="R_kgDOJFU7OQ"
    data-category="Announcements"
    data-category-id="DIC_kwDOJFU7Oc4CUyC7"
    data-mapping="title"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="preferred_color_scheme"
    data-lang="zh-CN"
    crossorigin
    async
></script>





        
    </body>
</html>
