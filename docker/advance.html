
<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <title>进阶使用 | IceOfSummerの博客</title>
        <meta name="author" content="IceOfSummer" />
        <meta name="description" content="用来用去还是自己搭的博客靠谱" />
        <meta name="keywords" content="" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
        <script src="https://cdn.staticfile.org/vue/3.2.47/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.3.0/css/all.min.css" />
<link rel="stylesheet" href="https://selfb.asia/static/particlex/static/fonts.min.css" />
<script>
  const mixins = {};
  const h = (arg1, arg2, arg3) => {
    if (arg2.attrs) {
      Object.assign(arg2, arg2.attrs)
      Reflect.deleteProperty(arg2, 'attrs')
    }
    if (arg2.on) {
      Object.keys(arg2.on).forEach(key => {
        const head = key.charAt(0).toUpperCase()
        arg2['on' + head  + key.substring(1)] = arg2.on[key]
      })
      Reflect.deleteProperty(arg2, 'on')
    }
    return Vue.h(arg1, arg2, arg3)
  }
</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>


<script src="https://cdn.staticfile.org/highlight.js/11.7.0/highlight.min.js"></script>
<link
    rel="stylesheet"
    href="https://cdn.staticfile.org/highlight.js/11.7.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

  <script src="/js/lib/toc.js"></script>



  <script src="/js/lib/lazy-load-support.js"></script>


    <meta name="generator" content="Hexo 7.1.1"></head>
    <body>
        <div id="layout">
            <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
            </transition>
            <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/">
            <span>ICEOFSUMMERの博客</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;ICEOFSUMMERの博客</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>进阶使用</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/4/23
        </span>
        
        <span class="category">
            <a href="/2023/04/20/docker/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                Docker
            </a>
        </span>
        
        
    </div>
    
    <toc-component></toc-component>
    <div class="content" v-pre id="main-content">
        <h1 id="1-MySQL部署"><a href="#1-MySQL部署" class="headerlink" title="1. MySQL部署"></a>1. MySQL部署</h1><h2 id="1-1-MySQL主从配置"><a href="#1-1-MySQL主从配置" class="headerlink" title="1.1 MySQL主从配置"></a>1.1 MySQL主从配置</h2><p>启动MySQL主机：</p>
<pre><code class="shell">docker run -p 3307:3306 --name=mysql-master --privileged=true \
-v /mydata/mysql-master/log:/var/log/mysql \
-v /mydata/mysql-master/data:/var/lib/mysql \
-v /mydata/mysql-master/conf:/etc/mysql \
-v /home/mysql/mysql-files:/var/lib/mysql-files \
-e MYSQL_ROOT_PASSWORD=root \
-d mysql
</code></pre>
<p>进入配置文件夹(&#x2F;mydata&#x2F;mysql-master&#x2F;conf)，添加配置文件my.cnf：</p>
<pre><code class="text">[mysqld]
## 设置server_id，同一局域网中需要唯一
server_id=101
## 指定不需要同步的数据库名称
binlog-ignore-db=mysql
## 开启二进制日志功能
log-bin=mall-mysql-bin
## 设置二进制日志使用内存大小(事务)
binlog_cache_size=1M
## 设置使用的二进制日志格式(mixed, statement, row)
binlog_format=mixed
## 二进制日志过期清理时间。默认为0表示不清理
expire_logs_days=7
## 跳过主从复制中遇到的所有的错误或指定类型的错误，避免slave端复制中断。
## 如：1062错误是指一些主键重复，1032是指主从数据库不一致
slave_skip_errors=1062
</code></pre>
<p>进入主数据库创建从机账号：</p>
<pre><code class="shell">CREATE USER &#39;slave&#39;@&#39;%&#39; IDENTIFIED BY &#39;123456&#39;;
GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &#39;slave&#39;@&#39;%&#39;;
</code></pre>
<p>启动从数据库：</p>
<pre><code class="shell">docker run -p 3308:3306 --name=mysql-slave --privileged=true \
-v /mydata/mysql-slave/log:/var/log/mysql \
-v /mydata/mysql-slave/data:/var/lib/mysql \
-v /mydata/mysql-slave/conf:/etc/mysql \
-v /home/mysql-slave/mysql-files:/var/lib/mysql-files \
-e MYSQL_ROOT_PASSWORD=root \
-d mysql
</code></pre>
<p>添加配置文件(my.cnf)：</p>
<pre><code class="text">[mysqld]
## 设置server_id，同一局域网中需要唯一
server_id=102
## 指定不需要同步的数据库名称
binlog-ignore-db=mysql
## 开启二进制日志功能
log-bin=mall-mysql-slave1-bin
## 设置二进制日志使用内存大小(事务)
binlog_cache_size=1M
## 设置使用的二进制日志格式(mixed, statement, row)
binlog_format=mixed
## 二进制日志过期清理时间。默认为0表示不清理
expire_logs_days=7
## 跳过主从复制中遇到的所有的错误或指定类型的错误，避免slave端复制中断。
## 如：1062错误是指一些主键重复，1032是指主从数据库不一致
slave_skip_errors=1062
## log_slave_updates表示slave将复制事件写进自己的二进制日志
log_slave_updates=1
## slave设置为只读
read_only=1
## relay_log配置中继日志
relay_log=mall-mysql-relay-bin
</code></pre>
<p>在主数据库中查看主从同步状态：</p>
<pre><code class="shell">mysql&amp;gt; show master status;
+-----------------------+----------+--------------+------------------+-------------------+
| File                  | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+-----------------------+----------+--------------+------------------+-------------------+
| mall-mysql-bin.000005 |      712 |              | mysql            |                   |
+-----------------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)
</code></pre>
<p>在从数据库中配置主从复制：</p>
<pre><code class="shell">change master to master_host=&quot;宿主机ip&quot;, master_user=&#39;slave&#39;, master_password=&#39;123456&#39;, master_port=3307, master_log_file=&#39;mall-mysql-bin.000005&#39;, master_log_pos=712, master_connect_retry=30
</code></pre>
<p>在从数据库中查看主从复制状态：</p>
<pre><code class="shell">mysql&amp;gt; show slave status \G;
*************************** 1. row ***************************
               Slave_IO_State: 
                  Master_Host: 192.168.170.131
                  Master_User: slave
                  Master_Port: 3307
                Connect_Retry: 30
              Master_Log_File: mall-mysql-bin.000005
          Read_Master_Log_Pos: 712
               Relay_Log_File: mall-mysql-relay-bin.000001
                Relay_Log_Pos: 4
        Relay_Master_Log_File: mall-mysql-bin.000005
             Slave_IO_Running: No
            Slave_SQL_Running: No
            
    ...
    
1 row in set, 1 warning (0.01 sec)
</code></pre>
<p>在从数据库中开启主从同步：</p>
<pre><code class="shell">start slave;
</code></pre>
<h1 id="2-Redis分布式部署"><a href="#2-Redis分布式部署" class="headerlink" title="2. Redis分布式部署"></a>2. Redis分布式部署</h1><p>Redis分布式哈希主要使用哈希槽实现。这里将以3主3从的方式演示。</p>
<p>启动6个redis：</p>
<pre><code class="shell">docker run -d --name redis-node-1 --net host --privileged=true -v /data/redis/share/redis-node-1:/data redis --cluster-enabled yes --appendonly yes --port 6381

docker run -d --name redis-node-2 --net host --privileged=true -v /data/redis/share/redis-node-2:/data redis --cluster-enabled yes --appendonly yes --port 6382

docker run -d --name redis-node-3 --net host --privileged=true -v /data/redis/share/redis-node-3:/data redis --cluster-enabled yes --appendonly yes --port 6383

docker run -d --name redis-node-4 --net host --privileged=true -v /data/redis/share/redis-node-4:/data redis --cluster-enabled yes --appendonly yes --port 6384

docker run -d --name redis-node-5 --net host --privileged=true -v /data/redis/share/redis-node-5:/data redis --cluster-enabled yes --appendonly yes --port 6385

docker run -d --name redis-node-6 --net host --privileged=true -v /data/redis/share/redis-node-6:/data redis --cluster-enabled yes --appendonly yes --port 6386
</code></pre>
<p>进入redis容器后，输入如下指令：</p>
<pre><code class="shell">redis-cli --cluster create 192.168.170.131:6381 192.168.170.131:6382 192.168.170.131:6383 192.168.170.131:6384 192.168.170.131:6385 192.168.170.131:6386 --cluster-replicas 1
</code></pre>
<p>这里的IP需要修改为自己的，<code>--cluster-replicas</code>表示为每一个master创建一个<code>slave</code>节点。</p>
<p>运行结果：</p>
<pre><code class="shell">[root@localhost ~]# docker exec -it redis-node-1 /bin/bash
root@localhost:/data# redis-cli --cluster create 192.168.170.131:6381 192.168.170.131:6382 192.168.170.131:6383 192.168.170.131:6384 192.168.170.131:6385 192.168.170.131:6386 --cluster-replicas 1
&amp;gt;&amp;gt;&amp;gt; Performing hash slots allocation on 6 nodes...
Master[0] -&amp;gt; Slots 0 - 5460
Master[1] -&amp;gt; Slots 5461 - 10922
Master[2] -&amp;gt; Slots 10923 - 16383
Adding replica 192.168.170.131:6385 to 192.168.170.131:6381
Adding replica 192.168.170.131:6386 to 192.168.170.131:6382
Adding replica 192.168.170.131:6384 to 192.168.170.131:6383
&amp;gt;&amp;gt;&amp;gt; Trying to optimize slaves allocation for anti-affinity
[WARNING] Some slaves are in the same host as their master
M: f68a76ffd6a7d405ee7d9645c28964ec3f6d56f5 192.168.170.131:6381
   slots:[0-5460] (5461 slots) master
M: 3966aca2c22809e62891386d1fe815edb8a13c4d 192.168.170.131:6382
   slots:[5461-10922] (5462 slots) master
M: 8513fb8649e422c0082baf1c53a3fc618eff2ced 192.168.170.131:6383
   slots:[10923-16383] (5461 slots) master
S: 9dcca86c999abdad29214c1167c6a41d6861d78d 192.168.170.131:6384
   replicates 3966aca2c22809e62891386d1fe815edb8a13c4d
S: af329601a2212a38377611fa808844a12089fad6 192.168.170.131:6385
   replicates 8513fb8649e422c0082baf1c53a3fc618eff2ced
S: 4552034720a87b8fa6d2b5411f2d275c260113d0 192.168.170.131:6386
   replicates f68a76ffd6a7d405ee7d9645c28964ec3f6d56f5
Can I set the above configuration? (type &#39;yes&#39; to accept): yes
&amp;gt;&amp;gt;&amp;gt; Nodes configuration updated
&amp;gt;&amp;gt;&amp;gt; Assign a different config epoch to each node
&amp;gt;&amp;gt;&amp;gt; Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join
.
&amp;gt;&amp;gt;&amp;gt; Performing Cluster Check (using node 192.168.170.131:6381)
M: f68a76ffd6a7d405ee7d9645c28964ec3f6d56f5 192.168.170.131:6381
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
M: 3966aca2c22809e62891386d1fe815edb8a13c4d 192.168.170.131:6382
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
S: 9dcca86c999abdad29214c1167c6a41d6861d78d 192.168.170.131:6384
   slots: (0 slots) slave
   replicates 3966aca2c22809e62891386d1fe815edb8a13c4d
S: af329601a2212a38377611fa808844a12089fad6 192.168.170.131:6385
   slots: (0 slots) slave
   replicates 8513fb8649e422c0082baf1c53a3fc618eff2ced
M: 8513fb8649e422c0082baf1c53a3fc618eff2ced 192.168.170.131:6383
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
S: 4552034720a87b8fa6d2b5411f2d275c260113d0 192.168.170.131:6386
   slots: (0 slots) slave
   replicates f68a76ffd6a7d405ee7d9645c28964ec3f6d56f5
[OK] All nodes agree about slots configuration.
&amp;gt;&amp;gt;&amp;gt; Check for open slots...
&amp;gt;&amp;gt;&amp;gt; Check slots coverage...
[OK] All 16384 slots covered.
</code></pre>
<p>查看集群状态：</p>
<pre><code class="shell">## redis-cli
cluster info
cluster nodes

## shell
redis-cli --cluster check [host]:[port]
</code></pre>
<p>主从机的指定是随机的，每次都可能不同。</p>
<p>在连接redis时需要添加<code>-c</code>参数，以集群的方式连接：</p>
<pre><code class="shell">redis-cli -p 6381 -c
</code></pre>
<p>进入1号节点，若不使用<code>-c</code>参数：</p>
<pre><code class="shell">127.0.0.1:6381&amp;gt; set k1 v1
(error) MOVED 12706 192.168.170.131:6383
</code></pre>
<p>使用<code>-c</code>参数：</p>
<pre><code class="shell">127.0.0.1:6381&amp;gt; set k1 v1
-&amp;gt; Redirected to slot [12706] located at 192.168.170.131:6383
OK
</code></pre>
<h2 id="2-1-Redis主从切换"><a href="#2-1-Redis主从切换" class="headerlink" title="2.1 Redis主从切换"></a>2.1 Redis主从切换</h2><p>上面我们部署了3主3从后，此时我们关闭1号节点，期望6号机能够”上位”。</p>
<p>关闭1号节点：</p>
<pre><code class="shell">docker stop redis-node-1
</code></pre>
<p>进入任意节点，查看节点状态：</p>
<pre><code class="shell">127.0.0.1:6382&amp;gt; cluster nodes
8513fb8649e422c0082baf1c53a3fc618eff2ced 192.168.170.131:6383@16383 master - 0 1682330542000 3 connected 10923-16383
9dcca86c999abdad29214c1167c6a41d6861d78d 192.168.170.131:6384@16384 slave 3966aca2c22809e62891386d1fe815edb8a13c4d 0 1682330541000 2 connected
4552034720a87b8fa6d2b5411f2d275c260113d0 192.168.170.131:6386@16386 master - 0 1682330542667 7 connected 0-5460
af329601a2212a38377611fa808844a12089fad6 192.168.170.131:6385@16385 slave 8513fb8649e422c0082baf1c53a3fc618eff2ced 0 1682330541663 3 connected
f68a76ffd6a7d405ee7d9645c28964ec3f6d56f5 192.168.170.131:6381@16381 master,fail - 1682330496440 1682330493000 1 disconnected
3966aca2c22809e62891386d1fe815edb8a13c4d 192.168.170.131:6382@16382 myself,master - 0 1682330541000 2 connected 5461-10922
</code></pre>
<p>可以发现6号节点已经成为master节点。在1号节点重启后，1号节点会变为slave状态，6号节点会仍然是master。</p>
<h2 id="2-2-Redis主从扩容"><a href="#2-2-Redis主从扩容" class="headerlink" title="2.2 Redis主从扩容"></a>2.2 Redis主从扩容</h2><p>新增两个容器：</p>
<pre><code class="shell">docker run -d --name redis-node-7 --net host --privileged=true -v /data/redis/share/redis-node-7:/data redis --cluster-enabled yes --appendonly yes --port 6387

docker run -d --name redis-node-8 --net host --privileged=true -v /data/redis/share/redis-node-8:/data redis --cluster-enabled yes --appendonly yes --port 6388
</code></pre>
<p>将新增的6387作为master节点加入集群：</p>
<pre><code class="shell">redis-cli --cluster add-node [自己的IP]:6387 [某一集群Reids的IP]:[PORT]
</code></pre>
<p>在新增的节点默认不会被分配槽位：</p>
<pre><code class="shell">root@localhost:/data# redis-cli --cluster check 192.168.170.131:6387
192.168.170.131:6387 (693799ad...) -&amp;gt; 0 keys | 0 slots | 0 slaves.
192.168.170.131:6382 (3966aca2...) -&amp;gt; 0 keys | 5462 slots | 1 slaves.
192.168.170.131:6383 (8513fb86...) -&amp;gt; 1 keys | 5461 slots | 1 slaves.
192.168.170.131:6386 (45520347...) -&amp;gt; 2 keys | 5461 slots | 1 slaves.
</code></pre>
<p>使用如下指令重新分配槽号：</p>
<pre><code class="shell">redis-cli --cluster reshard [IP]:[PORT]
</code></pre>
<pre><code class="shell">root@localhost:/data# redis-cli --cluster reshard 192.168.170.131:6387
&amp;gt;&amp;gt;&amp;gt; Performing Cluster Check (using node 192.168.170.131:6387)
M: 693799adb79799c38a343feb09a6df95f60a0fb4 192.168.170.131:6387
   slots: (0 slots) master
S: 9dcca86c999abdad29214c1167c6a41d6861d78d 192.168.170.131:6384
   slots: (0 slots) slave
   replicates 3966aca2c22809e62891386d1fe815edb8a13c4d
M: 3966aca2c22809e62891386d1fe815edb8a13c4d 192.168.170.131:6382
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
M: 8513fb8649e422c0082baf1c53a3fc618eff2ced 192.168.170.131:6383
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
M: 4552034720a87b8fa6d2b5411f2d275c260113d0 192.168.170.131:6386
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
S: f68a76ffd6a7d405ee7d9645c28964ec3f6d56f5 192.168.170.131:6381
   slots: (0 slots) slave
   replicates 4552034720a87b8fa6d2b5411f2d275c260113d0
S: af329601a2212a38377611fa808844a12089fad6 192.168.170.131:6385
   slots: (0 slots) slave
   replicates 8513fb8649e422c0082baf1c53a3fc618eff2ced
[OK] All nodes agree about slots configuration.
&amp;gt;&amp;gt;&amp;gt; Check for open slots...
&amp;gt;&amp;gt;&amp;gt; Check slots coverage...
[OK] All 16384 slots covered.
# 这里由于是4台机器，需要给平分出来就是4096，意思是给新机器分4096个槽出去
How many slots do you want to move (from 1 to 16384)? 4096
# 要分配的节点ID
What is the receiving node ID? 693799adb79799c38a343feb09a6df95f60a0fb4
Please enter all the source node IDs.
  Type &#39;all&#39; to use all the nodes as source nodes for the hash slots.
  Type &#39;done&#39; once you entered all the source nodes IDs.
# 这里表示谁来出这些槽位，使用all表示从所有主节点中拿出槽位
Source node #1: all
</code></pre>
<p>再次检查集群状态：</p>
<pre><code class="shell">root@localhost:/data# redis-cli --cluster check 192.168.170.131:6387
192.168.170.131:6387 (693799ad...) -&amp;gt; 1 keys | 4096 slots | 0 slaves.
192.168.170.131:6382 (3966aca2...) -&amp;gt; 0 keys | 4096 slots | 1 slaves.
192.168.170.131:6383 (8513fb86...) -&amp;gt; 1 keys | 4096 slots | 1 slaves.
192.168.170.131:6386 (45520347...) -&amp;gt; 1 keys | 4096 slots | 1 slaves.
[OK] 3 keys in 4 masters.
0.00 keys per slot on average.
&amp;gt;&amp;gt;&amp;gt; Performing Cluster Check (using node 192.168.170.131:6387)
M: 693799adb79799c38a343feb09a6df95f60a0fb4 192.168.170.131:6387
   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
S: 9dcca86c999abdad29214c1167c6a41d6861d78d 192.168.170.131:6384
   slots: (0 slots) slave
   replicates 3966aca2c22809e62891386d1fe815edb8a13c4d
M: 3966aca2c22809e62891386d1fe815edb8a13c4d 192.168.170.131:6382
   slots:[6827-10922] (4096 slots) master
   1 additional replica(s)
M: 8513fb8649e422c0082baf1c53a3fc618eff2ced 192.168.170.131:6383
   slots:[12288-16383] (4096 slots) master
   1 additional replica(s)
M: 4552034720a87b8fa6d2b5411f2d275c260113d0 192.168.170.131:6386
   slots:[1365-5460] (4096 slots) master
   1 additional replica(s)
S: f68a76ffd6a7d405ee7d9645c28964ec3f6d56f5 192.168.170.131:6381
   slots: (0 slots) slave
   replicates 4552034720a87b8fa6d2b5411f2d275c260113d0
S: af329601a2212a38377611fa808844a12089fad6 192.168.170.131:6385
   slots: (0 slots) slave
   replicates 8513fb8649e422c0082baf1c53a3fc618eff2ced
[OK] All nodes agree about slots configuration.
&amp;gt;&amp;gt;&amp;gt; Check for open slots...
&amp;gt;&amp;gt;&amp;gt; Check slots coverage...
[OK] All 16384 slots covered.
</code></pre>
<p><font color=red>可以发现扩容时，已有节点的右区间不变，每次都是在左区间”平分”给新的节点，新节点的哈希槽并不是连续的</font>。</p>
<p>最后再将最后一个从节点加入集群：</p>
<pre><code class="shell">redis-cli --cluster add-node [从机Host]:[从机PORT] [主机Host]:[主机PORT] --cluster-slave --cluster-master-id [主节点ID]
</code></pre>
<h2 id="2-3-Redis主从缩容"><a href="#2-3-Redis主从缩容" class="headerlink" title="2.3 Redis主从缩容"></a>2.3 Redis主从缩容</h2><p>Redis集群缩容，在这里删除6387和6388节点。</p>
<p>首先需要删除从节点：</p>
<pre><code class="shell">redis-cli --cluster del-node [从机HOST]:[从机IP] [从机节点ID]
</code></pre>
<pre><code class="shell">root@localhost:/data# redis-cli --cluster del-node 192.168.170.131:6388 21b32459b66ff851ee5eaa540749589484172909
&amp;gt;&amp;gt;&amp;gt; Removing node 21b32459b66ff851ee5eaa540749589484172909 from cluster 192.168.170.131:6388
&amp;gt;&amp;gt;&amp;gt; Sending CLUSTER FORGET messages to the cluster...
&amp;gt;&amp;gt;&amp;gt; Sending CLUSTER RESET SOFT to the deleted node.
</code></pre>
<p>之后删除主节点，并将它的槽位全部分配给另外一个主节点：</p>
<pre><code class="shell">redis-cli --cluster reshard [要分配给的节点Host]:[节点PORT]
</code></pre>
<pre><code class="shell">root@localhost:/data# redis-cli --cluster del-node 192.168.170.131:6388 21b32459b66ff851ee5eaa540749589484172909
&amp;gt;&amp;gt;&amp;gt; Removing node 21b32459b66ff851ee5eaa540749589484172909 from cluster 192.168.170.131:6388
&amp;gt;&amp;gt;&amp;gt; Sending CLUSTER FORGET messages to the cluster...
&amp;gt;&amp;gt;&amp;gt; Sending CLUSTER RESET SOFT to the deleted node.
root@localhost:/data# redis-cli --cluster reshard 192.168.170.131:6381
&amp;gt;&amp;gt;&amp;gt; Performing Cluster Check (using node 192.168.170.131:6381)
S: f68a76ffd6a7d405ee7d9645c28964ec3f6d56f5 192.168.170.131:6381
   slots: (0 slots) slave
   replicates 4552034720a87b8fa6d2b5411f2d275c260113d0
M: 3966aca2c22809e62891386d1fe815edb8a13c4d 192.168.170.131:6382
   slots:[6827-10922] (4096 slots) master
   1 additional replica(s)
M: 4552034720a87b8fa6d2b5411f2d275c260113d0 192.168.170.131:6386
   slots:[1365-5460] (4096 slots) master
   1 additional replica(s)
S: af329601a2212a38377611fa808844a12089fad6 192.168.170.131:6385
   slots: (0 slots) slave
   replicates 8513fb8649e422c0082baf1c53a3fc618eff2ced
M: 8513fb8649e422c0082baf1c53a3fc618eff2ced 192.168.170.131:6383
   slots:[12288-16383] (4096 slots) master
   1 additional replica(s)
M: 693799adb79799c38a343feb09a6df95f60a0fb4 192.168.170.131:6387
   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
S: 9dcca86c999abdad29214c1167c6a41d6861d78d 192.168.170.131:6384
   slots: (0 slots) slave
   replicates 3966aca2c22809e62891386d1fe815edb8a13c4d
[OK] All nodes agree about slots configuration.
&amp;gt;&amp;gt;&amp;gt; Check for open slots...
&amp;gt;&amp;gt;&amp;gt; Check slots coverage...
[OK] All 16384 slots covered.
How many slots do you want to move (from 1 to 16384)? 4096
# 谁接收
What is the receiving node ID? 4552034720a87b8fa6d2b5411f2d275c260113d0
Please enter all the source node IDs.
  Type &#39;all&#39; to use all the nodes as source nodes for the hash slots.
  Type &#39;done&#39; once you entered all the source nodes IDs.
# 节点6387&quot;出血&quot;
Source node #1: 693799adb79799c38a343feb09a6df95f60a0fb4
Source node #2: done
</code></pre>
<p>检查集群状态：</p>
<pre><code class="shell">root@localhost:/data# redis-cli --cluster check 192.168.170.131:6381
192.168.170.131:6382 (3966aca2...) -&amp;gt; 0 keys | 4096 slots | 1 slaves.
192.168.170.131:6386 (45520347...) -&amp;gt; 2 keys | 8192 slots | 1 slaves.
192.168.170.131:6383 (8513fb86...) -&amp;gt; 1 keys | 4096 slots | 1 slaves.
192.168.170.131:6387 (693799ad...) -&amp;gt; 0 keys | 0 slots | 0 slaves.
</code></pre>
<p>最后可以直接将6387删除：</p>
<pre><code class="shell">redis-cli --cluster del-node [IP]:[PORT] [节点ID]
</code></pre>

    </div>
    
    
    
    
    <div id="comment">
        <div id="giscus-container" class="giscus"></div>
    </div>
    
    
    
    
</div>

                <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2024 IceOfSummerの博客
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;IceOfSummer
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

            </div>
            </transition>
            
            <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
            </transition>
            
        </div>
        <script src="/js/main.js"></script>
        
        
<script
    src="https://giscus.app/client.js"
    data-repo="IceOfSummer/iceofsummer.github.io"
    data-repo-id="R_kgDOJFU7OQ"
    data-category="Announcements"
    data-category-id="DIC_kwDOJFU7Oc4CUyC7"
    data-mapping="title"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="preferred_color_scheme"
    data-lang="zh-CN"
    crossorigin
    async
></script>





        
    </body>
</html>
